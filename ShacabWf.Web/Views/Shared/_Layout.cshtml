<!DOCTYPE html>
@{
    // Get the current user's theme preference
    var theme = "Default";
    if (User.Identity?.IsAuthenticated == true)
    {
        var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId) && int.TryParse(userId, out int id))
        {
            var user = await Context.RequestServices.GetService<ShacabWf.Web.Services.IAuthService>()?.GetUserByIdAsync(id);
            if (user != null)
            {
                theme = user.Theme ?? "Default";
            }
        }
    }
    
    // Store theme in ViewData for use throughout the layout
    ViewData["CurrentTheme"] = theme;
}
<html lang="en" class="h-100">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SHACAB</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="~/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="~/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="~/favicon/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="~/favicon/apple-touch-icon.png">
    <link rel="manifest" href="~/favicon/site.webmanifest">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/logo-themes.css" asp-append-version="true" />
    
    @{
        // Debug statement to see what theme is being loaded
        <script>console.log("Current theme: @ViewData["CurrentTheme"]");</script>
        
        // Include the theme CSS if it's not the default theme
        if (!string.IsNullOrEmpty(ViewData["CurrentTheme"]?.ToString()) && ViewData["CurrentTheme"]?.ToString() != "Default")
        {
            <link rel="stylesheet" href="~/css/@(ViewData["CurrentTheme"]?.ToString().ToLower())-theme.css" asp-append-version="true" />
        }
    }
    @RenderSection("Styles", required: false)
</head>
<body class="d-flex flex-column h-100 @(ViewData["CurrentTheme"]?.ToString().ToLower())-theme">
    <header>
        <nav class="navbar navbar-expand-sm navbar-dark bg-primary mb-3">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center" asp-controller="Home" asp-action="Simple">
                    <svg class="theme-logo me-2" width="32" height="32" viewBox="0 0 200 200">
                        <circle class="logo-circle" cx="100" cy="100" r="95" />
                        <circle class="logo-inner-circle" cx="100" cy="100" r="85" />
                        <path class="logo-car" d="M140,90 H60 L70,70 H130 L140,90 Z M145,95 C145,95 150,110 150,115 C150,120 145,120 145,120 H135 C135,120 130,120 130,115 C130,110 135,110 135,110 H140 C140,110 140,105 140,105 H60 C60,105 60,110 60,110 H65 C65,110 70,110 70,115 C70,120 65,120 65,120 H55 C55,120 50,120 50,115 C50,110 55,95 55,95 H145 Z" />
                        <text class="logo-text" x="100" y="155" font-family="Arial, sans-serif" font-weight="bold" font-size="32" text-anchor="middle">CAB</text>
                        <rect class="logo-checkers" x="70" y="165" width="10" height="10" />
                        <rect class="logo-checkers" x="90" y="165" width="10" height="10" />
                        <rect class="logo-checkers" x="110" y="165" width="10" height="10" />
                        <rect class="logo-checkers" x="130" y="165" width="10" height="10" />
                        <rect class="logo-checkers" x="80" y="175" width="10" height="10" />
                        <rect class="logo-checkers" x="100" y="175" width="10" height="10" />
                        <rect class="logo-checkers" x="120" y="175" width="10" height="10" />
                    </svg>
                    SHACAB
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="Home" asp-action="Simple"><i class="bi bi-house"></i> Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="ChangeRequests" asp-action="Index"><i class="bi bi-list-check"></i> Change Requests</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-controller="ChangeRequests" asp-action="MyRequests"><i class="bi bi-person-lines-fill"></i> My Requests</a>
                        </li>
                        @{
                            // Check if user has any elevated role beyond just "User"
                            bool hasElevatedRole = User.IsInRole("Admin") || 
                                                  User.IsInRole("CABMember") || 
                                                  User.IsInRole("Supervisor") || 
                                                  User.IsInRole("Approver") || 
                                                  User.IsInRole("Implementer") ||
                                                  User.IsInRole("Support");
                        }
                        
                        @if (hasElevatedRole)
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="ChangeRequests" asp-action="Cab">
                                    <i class="bi bi-speedometer2 me-1"></i>CAB Dashboard
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Home" asp-action="SimpleDashboard">
                                    <i class="bi bi-speedometer2 me-1"></i>Simple Dashboard
                                </a>
                            </li>
                        }
                        @if (User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="UserManagement" asp-action="Index">
                                    <i class="bi bi-people-fill me-1"></i>User Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-controller="Home" asp-action="TestData">
                                    <i class="bi bi-database-fill-gear me-1"></i>Test Data
                                </a>
                            </li>
                        }
                    </ul>
                    <partial name="_LoginPartial" />
                </div>
            </div>
        </nav>
    </header>
    <div class="container flex-grow-1">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted mt-auto">
        <div class="container">
            &copy; 2025 - SHACAB - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html> 